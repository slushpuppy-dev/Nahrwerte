'use strict';

/* --------------------------------------------------------------
 add_category_to_product.js 2015-10-01
 Gambio GmbH
 http://www.gambio.de
 Copyright (c) 2015 Gambio GmbH
 Released under the GNU General Public License (Version 2)
 [http://www.gnu.org/licenses/gpl-2.0.html]
 --------------------------------------------------------------
 */

/**
 * ## Adds a category dropdown to the categories box by clicking on the add button
 *
 * @module Controllers/anahrwert
 */
gx.controllers.module('nahrwert', [],

/** @lends module:Controllers/add_category_to_product */

function (data) {

	'use strict';

	// ------------------------------------------------------------------------
	// VARIABLE DEFINITION
	// ------------------------------------------------------------------------

	var
	/**
  * Module Selector
  *
  * @var {object}
  */
	$this = $(this),


	/**
  * Default Options
  *
  * @type {object}
  */
	defaults = {},


	/**
  * Final Options
  *
  * @var {object}
  */
	options = $.extend(true, {}, defaults, data),


	/**
  * Module Object
  *
  * @type {object}
  */
	module = {};

	// ------------------------------------------------------------------------
	// EVENT HANDLERS
	// ------------------------------------------------------------------------

	/**
  * add category dropdown when clicking add button
  *
  * @private
  */
	var _addCategory = function _addCategory() {
		var $newCategory = $this.find('.category-template').clone().removeClass('category-template').addClass('category-link-wrapper').removeClass('hidden');

		$this.find('.category-link-wrapper:last').removeClass('remove-border').after($newCategory);

		$newCategory.find('select').prop('disabled', false).on('change', _changeCategory);
	};

	/**
  * update displayed category path on dropdown change event
  *
  * @private
  */
	var _changeCategory = function _changeCategory() {
		var level = ($(this).find('option:selected').html().match(/&nbsp;/g) || []).length;
		var categories = [];

		if (level > 0) {
			categories.unshift($(this).find('option:selected').html().replace(/&nbsp;/g, ''));
		}

		if (level > 3) {
			$(this).find('option:selected').prevAll().each(function () {
				if (($(this).html().match(/&nbsp;/g) || []).length === level - 3 && level > 3) {
					level -= 3;
					categories.unshift($(this).html().replace(/&nbsp;/g, ''));
				}
			});
		}

		$(this).parents('.category-link-wrapper').find('.category-path').html(categories.join(' > '));
	};

	/**
  * Update displayed categories list for multi select on change event.
  *
  * @private
  */
	var _changeCategoryMultiSelect = function _changeCategoryMultiSelect() {
		var level,
		    processedLevel,
		    categories = [],
		    categoryPathArray = [],
		    selected = $(this).find('option:selected'),
		    $multiSelectContainer = $('.multi-select-container').parent();

		$.each(selected, function () {
			level = ($(this).html().match(/&nbsp;/g) || []).length;
			processedLevel = level;
			if (level > 0) {
				categoryPathArray = [];
				categoryPathArray.unshift($(this).html().replace(/&nbsp;/g, ''));

				$(this).prevAll().each(function () {
					if (($(this).html().match(/&nbsp;/g) || []).length === processedLevel - 3 && processedLevel > 3) {

						processedLevel -= 3;
						categoryPathArray.unshift($(this).html().replace(/&nbsp;/g, ''));
					}
				});
				categories.push(categoryPathArray);
			}
		});

		$multiSelectContainer.empty();
		if (categories.length > 0) {
			$.each(categories, function () {
				$multiSelectContainer.append('<div class="span12 multi-select-container">' + '<label class="category-path">' + this.join(' > ') + '</label></div>');
			});
		} else {
			$multiSelectContainer.append('<div class="span12 multi-select-container"></div>');
		}
	};

	// ------------------------------------------------------------------------
	// INITIALIZATION
	// ------------------------------------------------------------------------
	var _addNahrwertStandard = function() {
	
		var nutriton_energie = $('#nutriton_energie').val();
		var nutriton_energie_kj = $('#nutriton_energie_kj').val();
		var nutriton_protein = $('#nutriton_protein').val();
		var nutriton_kh = $('#nutriton_kh').val();
		var nutriton_kh_zucker = $('#nutriton_kh_zucker').val();
		var nutriton_f = $('#nutriton_f').val();
		var nutriton_f_gesaetigt = $('#nutriton_f_gesaetigt').val();
		var nutriton_ballast = $('#nutriton_ballast').val();
		var nutriton_salz = $('#nutriton_salz').val();
		var nutriton_serving_size = $('#nutriton_serving_size').val();
		var nutriton_servings = $('#nutriton_servings').val();
		
		var data_set = jse.libs.fallback._data($(this), 'nahrwertstandard');
		$.ajax({
			'type': 'POST',
			'url': 'NahrwertServicesAjaxHandler.inc.php?action=add_nahrwertstandard',
			'timeout': 30000,
			'dataType': 'json',
			'context': this,
			'data': {
				'nutriton_energie': nutriton_energie,
				'nutriton_energie_kj': nutriton_energie_kj,
				'nutriton_protein': nutriton_protein,
				'products_id': data_set.products_id,
                'nutriton_kh': nutriton_kh,
				'nutriton_kh_zucker': nutriton_kh_zucker,
				'nutriton_f': nutriton_f,
				'nutriton_f_gesaetigt': nutriton_f_gesaetigt,
				'nutriton_ballast': nutriton_ballast,
				'nutriton_salz': nutriton_salz,
				'nutriton_serving_size':nutriton_serving_size,
				'nutriton_servings':nutriton_servings
			},
			success: function success(response) {
					//		console.log(response.html);
								//$('#nahrwert_code_wrapper > .frame-content > table').html(response.html);
			//	$('#nahrwerte > td > table').html(response.html)
			}
		});
	
		return false;
	}
	
	var _add_bestandextern = function()
	{
		var bestand_dropdown = $('#bestand_dropdown').val();
		var dropship_dropdown = $('#dropship_dropdown').val();
		var dropship_dropdown_text = $('#dropship_dropdown :selected').text();
		var dropship_lieferant = $('#dropship_dropdown :selected').text().split(" - ")[0];
		//alert("save -> bestand_dropdown" + bestand_dropdown + " dropship_dropdown " + dropship_dropdown);
		
		var data_set = jse.libs.fallback._data($(this), 'nahrwert');
		
		$.ajax({
			'type': 'POST',
			'url': 'BestandServiceAjaxHandler.inc.php?action=add_bestand',
			'timeout': 30000,
			'dataType': 'json',
			'context': this,
			'data': {
				'products_properties_combis_id': bestand_dropdown,
				'products_id': data_set.products_id,
				'products_drop_lieferant': dropship_lieferant,
				'products_drop_id': dropship_dropdown
			},
			success: function success(response) {
				if(response.error=="")
				{alert(response.html);}
			else{
					alert(response.error);		
			}
								//$('#nahrwert_code_wrapper > .frame-content > table').html(response.html);
				$('#dropsh > td > table').html(response.html)
			}
		});
	
		return false;
		
		
		
		
	}
	
	var _addNahrwert = function() {
	
	
		var nutrition_label_order = $('#nutrition_label_order').val();
		var nutriton_per_day = $('#nutriton_per_day').val();
		var nutrition_einheit = $('#nutrition_einheit').val();
		var nutrition_quantity = $('#nutrition_quantity').val();
		var nutrition_dropdown = $('#nutrition_dropdown').val();
		var nutrition_eingerueckt = $('#nutrition_eingerueckt').val();
		var nutrition_text = $('#nutrition_text').val();
		
		//alert('Hallo in Nahrwert '     + nutrition_dropdown+'-'+ nutrition_quantity+'-'+ nutrition_einheit+'-'+ nutriton_per_day+'-'+ nutrition_label_order);
		var data_set = jse.libs.fallback._data($(this), 'nahrwert');

		
		$.ajax({
			'type': 'POST',
			'url': 'NahrwertServicesAjaxHandler.inc.php?action=add_nahrwert',
			'timeout': 30000,
			'dataType': 'json',
			'context': this,
			'data': {

				'nutrition_dropdown': nutrition_dropdown,
				'nutriton_per_day': nutriton_per_day,
				'products_id': data_set.products_id,
				'page_token': data_set.page_token,
                'nutrition_quantity': nutrition_quantity,
				'nutrition_einheit': nutrition_einheit,
				'nutrition_label_order': nutrition_label_order,
				'nutrition_eingerueckt': nutrition_eingerueckt,
				'nutrition_text': nutrition_text
			},
			success: function success(response) {
			//	alert('go'+response.html);
				//$('#nahrwert_code_wrapper > .frame-content > table').html(response.html);
				$('#nahrwerte > td > table').html(response.html)
			}
		});
		
		return false;
	};
	
	var _deleteBestand = function(){
			var data_set = jse.libs.fallback._data($(this), 'bestand_modal_layer');
			alert('Wirklich löschen?'+data_set.id);
			$.ajax({
			'type': 'POST',
			'url': 'BestandServiceAjaxHandler.inc.php?action=delete_bestand',
			'timeout': 30000,
			'dataType': 'json',
			'context': this,
			'data': {

				'id': data_set.id,
				'products_id': data_set.products_id
			},
			success: function success(response) {
			
				//$('#nahrwert_code_wrapper > .frame-content > table').html(response.html);
				$('#dropsh > td > table').html(response.html);
				$(".delete_bestand").unbind('click');
				$('.delete_bestand').click(_deleteBestand);
			}
		});
	}
	
	var _deleteNahrwert = function() {
			var data_set = jse.libs.fallback._data($(this), 'nahrwert_modal_layer');
		alert('Wirklich löschen?'+data_set.id);
		
		$.ajax({
			'type': 'POST',
			'url': 'NahrwertServicesAjaxHandler.inc.php?action=delete_nahrwert',
			'timeout': 30000,
			'dataType': 'json',
			'context': this,
			'data': {

				'id': data_set.id,
				'products_id': data_set.products_id
			},
			success: function success(response) {
			//	alert('go delete\n\n '+response.html);
				//$('#nahrwert_code_wrapper > .frame-content > table').html(response.html);
				$('#nahrwerte > td > table').html(response.html);
				$('.delete_nahrwert').click(_deleteNahrwert);
				
			}
		});
		
		
	}
	
	var toggleNahrwert = function(){
		$('#nahrwert').fadeToggle("fast","linear");
	}
	var toggleBestand = function(){

		$('#bestand').fadeToggle("fast","linear");
	}

	/**
  * Init function of the widget
  */
	module.init = function (done) {
		var select = $this.find('select');
		$(".add_nahrwert").unbind('click');
		$('.add_nahrwert').click(_addNahrwert);
		$(".delete_nahrwert").unbind('click');
		$('.delete_nahrwert').click(_deleteNahrwert);
		$(".add_nahrwertstandard").unbind('click');
		$('.add_nahrwertstandard').click(_addNahrwertStandard);
		$("#nahrwertlabel").unbind('click');
		$('#nahrwertlabel').click(toggleNahrwert);
		$("#bestandlabel").unbind('click');
		$('#bestandlabel').click(toggleBestand);
		$(".add_bestandextern").unbind('click');
		$('.add_bestandextern').click(_add_bestandextern);
		$(".delete_bestand").unbind('click');
		$('.delete_bestand').click(_deleteBestand);
		
	

		if (select.prop('multiple')) {
			select.on('change', _changeCategoryMultiSelect);
			//select.on('change', _changeCategory);
		} else {
			select.on('change', _changeCategory);
		}

		done();
	};

	// Return data to widget engine
	return module;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb2R1Y3QvYWRkX2NhdGVnb3J5X3RvX3Byb2R1Y3QuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7Ozs7OztBQVVBOzs7OztBQUtBLEdBQUcsV0FBSCxDQUFlLE1BQWYsQ0FDQyx5QkFERCxFQUdDLEVBSEQ7O0FBS0M7O0FBRUEsVUFBUyxJQUFULEVBQWU7O0FBRWQ7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0M7Ozs7O0FBS0EsU0FBUSxFQUFFLElBQUYsQ0FOVDs7O0FBUUM7Ozs7O0FBS0EsWUFBVyxFQWJaOzs7QUFlQzs7Ozs7QUFLQSxXQUFVLEVBQUUsTUFBRixDQUFTLElBQVQsRUFBZSxFQUFmLEVBQW1CLFFBQW5CLEVBQTZCLElBQTdCLENBcEJYOzs7QUFzQkM7Ozs7O0FBS0EsVUFBUyxFQTNCVjs7QUE2QkE7QUFDQTtBQUNBOztBQUVBOzs7OztBQUtBLEtBQUksZUFBZSxTQUFmLFlBQWUsR0FBVztBQUM3QixNQUFJLGVBQWUsTUFBTSxJQUFOLENBQVcsb0JBQVgsRUFDakIsS0FEaUIsR0FFakIsV0FGaUIsQ0FFTCxtQkFGSyxFQUdqQixRQUhpQixDQUdSLHVCQUhRLEVBSWpCLFdBSmlCLENBSUwsUUFKSyxDQUFuQjs7QUFNQSxRQUFNLElBQU4sQ0FBVyw2QkFBWCxFQUNFLFdBREYsQ0FDYyxlQURkLEVBRUUsS0FGRixDQUVRLFlBRlI7O0FBSUEsZUFBYSxJQUFiLENBQWtCLFFBQWxCLEVBQ0UsSUFERixDQUNPLFVBRFAsRUFDbUIsS0FEbkIsRUFFRSxFQUZGLENBRUssUUFGTCxFQUVlLGVBRmY7QUFHQSxFQWREOztBQWdCQTs7Ozs7QUFLQSxLQUFJLGtCQUFrQixTQUFsQixlQUFrQixHQUFXO0FBQ2hDLE1BQUksUUFBUSxDQUFDLEVBQUUsSUFBRixFQUFRLElBQVIsQ0FBYSxpQkFBYixFQUFnQyxJQUFoQyxHQUF1QyxLQUF2QyxDQUE2QyxTQUE3QyxLQUEyRCxFQUE1RCxFQUFnRSxNQUE1RTtBQUNBLE1BQUksYUFBYSxF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QStCLE9BQS9CLEVBQXdDLFlBQXhDOztBQUVBLE1BQUksT0FBTyxJQUFQLENBQVksVUFBWixDQUFKLEVBQTZCO0FBQzVCLFVBQU8sRUFBUCxDQUFVLFFBQVYsRUFBb0IsMEJBQXBCO0FBQ0E7QUFDQSxHQUhELE1BR087QUFDTixVQUFPLEVBQVAsQ0FBVSxRQUFWLEVBQW9CLGVBQXBCO0FBQ0E7O0FBRUQ7QUFDQSxFQVpEOztBQWNBO0FBQ0EsUUFBTyxNQUFQO0FBQ0EsQ0FwS0YiLCJmaWxlIjoicHJvZHVjdC9hZGRfY2F0ZWdvcnlfdG9fcHJvZHVjdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gYWRkX2NhdGVnb3J5X3RvX3Byb2R1Y3QuanMgMjAxNS0xMC0wMVxuIEdhbWJpbyBHbWJIXG4gaHR0cDovL3d3dy5nYW1iaW8uZGVcbiBDb3B5cmlnaHQgKGMpIDIwMTUgR2FtYmlvIEdtYkhcbiBSZWxlYXNlZCB1bmRlciB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgKFZlcnNpb24gMilcbiBbaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2dwbC0yLjAuaHRtbF1cbiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICovXG5cbi8qKlxuICogIyMgQWRkcyBhIGNhdGVnb3J5IGRyb3Bkb3duIHRvIHRoZSBjYXRlZ29yaWVzIGJveCBieSBjbGlja2luZyBvbiB0aGUgYWRkIGJ1dHRvblxuICpcbiAqIEBtb2R1bGUgQ29udHJvbGxlcnMvYWRkX2NhdGVnb3J5X3RvX3Byb2R1Y3RcbiAqL1xuZ3guY29udHJvbGxlcnMubW9kdWxlKFxuXHQnYWRkX2NhdGVnb3J5X3RvX3Byb2R1Y3QnLFxuXHRcblx0W10sXG5cdFxuXHQvKiogQGxlbmRzIG1vZHVsZTpDb250cm9sbGVycy9hZGRfY2F0ZWdvcnlfdG9fcHJvZHVjdCAqL1xuXHRcblx0ZnVuY3Rpb24oZGF0YSkge1xuXHRcdFxuXHRcdCd1c2Ugc3RyaWN0Jztcblx0XHRcblx0XHQvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblx0XHQvLyBWQVJJQUJMRSBERUZJTklUSU9OXG5cdFx0Ly8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XG5cdFx0dmFyXG5cdFx0XHQvKipcblx0XHRcdCAqIE1vZHVsZSBTZWxlY3RvclxuXHRcdFx0ICpcblx0XHRcdCAqIEB2YXIge29iamVjdH1cblx0XHRcdCAqL1xuXHRcdFx0JHRoaXMgPSAkKHRoaXMpLFxuXHRcdFx0XG5cdFx0XHQvKipcblx0XHRcdCAqIERlZmF1bHQgT3B0aW9uc1xuXHRcdFx0ICpcblx0XHRcdCAqIEB0eXBlIHtvYmplY3R9XG5cdFx0XHQgKi9cblx0XHRcdGRlZmF1bHRzID0ge30sXG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogRmluYWwgT3B0aW9uc1xuXHRcdFx0ICpcblx0XHRcdCAqIEB2YXIge29iamVjdH1cblx0XHRcdCAqL1xuXHRcdFx0b3B0aW9ucyA9ICQuZXh0ZW5kKHRydWUsIHt9LCBkZWZhdWx0cywgZGF0YSksXG5cdFx0XHRcblx0XHRcdC8qKlxuXHRcdFx0ICogTW9kdWxlIE9iamVjdFxuXHRcdFx0ICpcblx0XHRcdCAqIEB0eXBlIHtvYmplY3R9XG5cdFx0XHQgKi9cblx0XHRcdG1vZHVsZSA9IHt9O1xuXHRcdFxuXHRcdC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHRcdC8vIEVWRU5UIEhBTkRMRVJTXG5cdFx0Ly8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XG5cdFx0LyoqXG5cdFx0ICogYWRkIGNhdGVnb3J5IGRyb3Bkb3duIHdoZW4gY2xpY2tpbmcgYWRkIGJ1dHRvblxuXHRcdCAqXG5cdFx0ICogQHByaXZhdGVcblx0XHQgKi9cblx0XHR2YXIgX2FkZENhdGVnb3J5ID0gZnVuY3Rpb24oKSB7XG5cdFx0XHR2YXIgJG5ld0NhdGVnb3J5ID0gJHRoaXMuZmluZCgnLmNhdGVnb3J5LXRlbXBsYXRlJylcblx0XHRcdFx0LmNsb25lKClcblx0XHRcdFx0LnJlbW92ZUNsYXNzKCdjYXRlZ29yeS10ZW1wbGF0ZScpXG5cdFx0XHRcdC5hZGRDbGFzcygnY2F0ZWdvcnktbGluay13cmFwcGVyJylcblx0XHRcdFx0LnJlbW92ZUNsYXNzKCdoaWRkZW4nKTtcblx0XHRcdFxuXHRcdFx0JHRoaXMuZmluZCgnLmNhdGVnb3J5LWxpbmstd3JhcHBlcjpsYXN0Jylcblx0XHRcdFx0LnJlbW92ZUNsYXNzKCdyZW1vdmUtYm9yZGVyJylcblx0XHRcdFx0LmFmdGVyKCRuZXdDYXRlZ29yeSk7XG5cdFx0XHRcblx0XHRcdCRuZXdDYXRlZ29yeS5maW5kKCdzZWxlY3QnKVxuXHRcdFx0XHQucHJvcCgnZGlzYWJsZWQnLCBmYWxzZSlcblx0XHRcdFx0Lm9uKCdjaGFuZ2UnLCBfY2hhbmdlQ2F0ZWdvcnkpO1xuXHRcdH07XG5cdFx0XG5cdFx0LyoqXG5cdFx0ICogdXBkYXRlIGRpc3BsYXllZCBjYXRlZ29yeSBwYXRoIG9uIGRyb3Bkb3duIGNoYW5nZSBldmVudFxuXHRcdCAqXG5cdFx0ICogQHByaXZhdGVcblx0XHQgKi9cblx0XHR2YXIgX2NoYW5nZUNhdGVnb3J5ID0gZnVuY3Rpb24oKSB7XG5cdFx0XHR2YXIgbGV2ZWwgPSAoJCh0aGlzKS5maW5kKCdvcHRpb246c2VsZWN0ZWQnKS5odG1sKCkubWF0Y2goLyZuYnNwOy9nKSB8fCBbXSkubGVuZ3RoO1xuXHRcdFx0dmFyIGNhdGVnb3JpZXMgPSBbXTtcblx0XHRcdFxuXHRcdFx0aWYgKGxldmVsID4gMCkge1xuXHRcdFx0XHRjYXRlZ29yaWVzLnVuc2hpZnQoJCh0aGlzKS5maW5kKCdvcHRpb246c2VsZWN0ZWQnKS5odG1sKCkucmVwbGFjZSgvJm5ic3A7L2csICcnKSk7XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdGlmIChsZXZlbCA+IDMpIHtcblx0XHRcdFx0JCh0aGlzKS5maW5kKCdvcHRpb246c2VsZWN0ZWQnKS5wcmV2QWxsKCkuZWFjaChmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRpZiAoKCQodGhpcykuaHRtbCgpLm1hdGNoKC8mbmJzcDsvZykgfHwgW10pLmxlbmd0aCA9PT0gbGV2ZWwgLSAzICYmIGxldmVsID4gMykge1xuXHRcdFx0XHRcdFx0bGV2ZWwgLT0gMztcblx0XHRcdFx0XHRcdGNhdGVnb3JpZXMudW5zaGlmdCgkKHRoaXMpLmh0bWwoKS5yZXBsYWNlKC8mbmJzcDsvZywgJycpKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHQkKHRoaXMpLnBhcmVudHMoJy5jYXRlZ29yeS1saW5rLXdyYXBwZXInKS5maW5kKCcuY2F0ZWdvcnktcGF0aCcpLmh0bWwoY2F0ZWdvcmllcy5qb2luKCcgPiAnKSk7XG5cdFx0fTtcblx0XHRcblx0XHRcblx0XHQvKipcblx0XHQgKiBVcGRhdGUgZGlzcGxheWVkIGNhdGVnb3JpZXMgbGlzdCBmb3IgbXVsdGkgc2VsZWN0IG9uIGNoYW5nZSBldmVudC5cblx0XHQgKlxuXHRcdCAqIEBwcml2YXRlXG5cdFx0ICovXG5cdFx0dmFyIF9jaGFuZ2VDYXRlZ29yeU11bHRpU2VsZWN0ID0gZnVuY3Rpb24oKSB7XG5cdFx0XHR2YXIgbGV2ZWwsXG5cdFx0XHRcdHByb2Nlc3NlZExldmVsLFxuXHRcdFx0XHRjYXRlZ29yaWVzID0gW10sXG5cdFx0XHRcdGNhdGVnb3J5UGF0aEFycmF5ID0gW10sXG5cdFx0XHRcdHNlbGVjdGVkID0gJCh0aGlzKS5maW5kKCdvcHRpb246c2VsZWN0ZWQnKSxcblx0XHRcdFx0JG11bHRpU2VsZWN0Q29udGFpbmVyID0gJCgnLm11bHRpLXNlbGVjdC1jb250YWluZXInKS5wYXJlbnQoKTtcblx0XHRcdFxuXHRcdFx0JC5lYWNoKHNlbGVjdGVkLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0bGV2ZWwgPSAoJCh0aGlzKS5odG1sKCkubWF0Y2goLyZuYnNwOy9nKSB8fCBbXSkubGVuZ3RoO1xuXHRcdFx0XHRwcm9jZXNzZWRMZXZlbCA9IGxldmVsO1xuXHRcdFx0XHRpZiAobGV2ZWwgPiAwKSB7XG5cdFx0XHRcdFx0Y2F0ZWdvcnlQYXRoQXJyYXkgPSBbXTtcblx0XHRcdFx0XHRjYXRlZ29yeVBhdGhBcnJheS51bnNoaWZ0KCQodGhpcykuaHRtbCgpLnJlcGxhY2UoLyZuYnNwOy9nLCAnJykpO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdCQodGhpcykucHJldkFsbCgpLmVhY2goZnVuY3Rpb24oKSB7XG5cdFx0XHRcdFx0XHRpZiAoKCQodGhpcykuaHRtbCgpLm1hdGNoKC8mbmJzcDsvZykgfHwgW10pLmxlbmd0aCA9PT1cblx0XHRcdFx0XHRcdFx0cHJvY2Vzc2VkTGV2ZWwgLVxuXHRcdFx0XHRcdFx0XHQzICYmXG5cdFx0XHRcdFx0XHRcdHByb2Nlc3NlZExldmVsID5cblx0XHRcdFx0XHRcdFx0Mykge1xuXHRcdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdFx0cHJvY2Vzc2VkTGV2ZWwgLT0gMztcblx0XHRcdFx0XHRcdFx0Y2F0ZWdvcnlQYXRoQXJyYXkudW5zaGlmdCgkKHRoaXMpLmh0bWwoKS5yZXBsYWNlKC8mbmJzcDsvZywgJycpKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRjYXRlZ29yaWVzLnB1c2goY2F0ZWdvcnlQYXRoQXJyYXkpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHRcdFxuXHRcdFx0JG11bHRpU2VsZWN0Q29udGFpbmVyLmVtcHR5KCk7XG5cdFx0XHRpZiAoY2F0ZWdvcmllcy5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdCQuZWFjaChjYXRlZ29yaWVzLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0XHQkbXVsdGlTZWxlY3RDb250YWluZXIuYXBwZW5kKCc8ZGl2IGNsYXNzPVwic3BhbjEyIG11bHRpLXNlbGVjdC1jb250YWluZXJcIj4nXG5cdFx0XHRcdFx0XHQrICc8bGFiZWwgY2xhc3M9XCJjYXRlZ29yeS1wYXRoXCI+JyArIHRoaXMuam9pbignID4gJykgKyAnPC9sYWJlbD48L2Rpdj4nKTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHQkbXVsdGlTZWxlY3RDb250YWluZXIuYXBwZW5kKCc8ZGl2IGNsYXNzPVwic3BhbjEyIG11bHRpLXNlbGVjdC1jb250YWluZXJcIj48L2Rpdj4nKTtcblx0XHRcdH1cblx0XHR9O1xuXHRcdFxuXHRcdC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXHRcdC8vIElOSVRJQUxJWkFUSU9OXG5cdFx0Ly8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cdFx0XG5cdFx0LyoqXG5cdFx0ICogSW5pdCBmdW5jdGlvbiBvZiB0aGUgd2lkZ2V0XG5cdFx0ICovXG5cdFx0bW9kdWxlLmluaXQgPSBmdW5jdGlvbihkb25lKSB7XG5cdFx0XHR2YXIgc2VsZWN0ID0gJHRoaXMuZmluZCgnc2VsZWN0Jyk7XG5cdFx0XHQkdGhpcy5maW5kKCcuYWRkLWNhdGVnb3J5Jykub24oJ2NsaWNrJywgX2FkZENhdGVnb3J5KTtcblx0XHRcdFxuXHRcdFx0aWYgKHNlbGVjdC5wcm9wKCdtdWx0aXBsZScpKSB7XG5cdFx0XHRcdHNlbGVjdC5vbignY2hhbmdlJywgX2NoYW5nZUNhdGVnb3J5TXVsdGlTZWxlY3QpO1xuXHRcdFx0XHQvL3NlbGVjdC5vbignY2hhbmdlJywgX2NoYW5nZUNhdGVnb3J5KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHNlbGVjdC5vbignY2hhbmdlJywgX2NoYW5nZUNhdGVnb3J5KTtcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0ZG9uZSgpO1xuXHRcdH07XG5cdFx0XG5cdFx0Ly8gUmV0dXJuIGRhdGEgdG8gd2lkZ2V0IGVuZ2luZVxuXHRcdHJldHVybiBtb2R1bGU7XG5cdH0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
